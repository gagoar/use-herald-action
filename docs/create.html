<!DOCTYPE html>

<head></head>

<body>
  <form action="" method="post" id="manifestForm">
    <input type="hidden" name="manifest" id="manifest" />
    <input type="hidden" name="appId" id="appId" />
    <input type="hidden" name="isOrg" id="isOrg" />
    <button type="submit" class="btn btn-primary mb-2">Submit</button>
  </form>

  Hold on tight... we're setting up your app...
</body>

<script src="./getParams.js"></script>

<script>
  // Get URL parameters
  const { appId, isOrg } = getParams(window.location.href);

  const ORG_ENDPOINT = `https://github.com/organizations/${appId}/settings/apps/new`;
  const PERSONAL_ENDPOINT = `https://github.com/settings/apps/new`;

  /*
   * For information on which permissions can be modified, refer to the docs:
   * https://docs.github.com/en/rest/reference/permissions-required-for-github-apps
   */

  const repo_permissions = {
    actions: 'read',
    administration: 'read',
    contents: 'read',
    issues: 'write',
    metadata: 'read',
    pull_requests: 'write',
    statuses: 'write',
  };

  const org_permissions = {
    members: 'read',
    team_discussions: 'read',
  };

  // This is the JSON payload that gets sent to GitHub to create the app
  const manifestJSON = {
    name: `[${appId}] Use Herald Action App`,
    url: 'https://cyamonide.github.io/use-herald-action',
    redirect_url: 'https://cyamonide.github.io/use-herald-action/token',
    public: true,
    default_permissions: {
      ...repo_permissions,
      ...org_permissions,
    },
  };

  // Inject manifest JSON into form
  document.getElementById('manifest').value = JSON.stringify(manifestJSON);
  document.getElementById('appId').value = appId;
  document.getElementById('isOrg').value = isOrg;

  // Customize form action
  document.getElementById('manifestForm').action = isOrg ? ORG_ENDPOINT : PERSONAL_ENDPOINT;

  // Submit form
  // document.getElementById('manifestForm').submit();
</script>
