<!DOCTYPE html>

<head>
  <title>UHA - Completing Handshake...</title>

  <link
    rel="stylesheet"
    href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z"
    crossorigin="anonymous"
  />
  <link rel="stylesheet" href="./main.css" />

  <script src="./utils.js"></script>
</head>

<body>
  <header>
    <img
      src="https://raw.githubusercontent.com/gagoar/use-herald-action/master/images/logo.png"
      alt="Use Herald Action logo"
    />
    <h1>Hold on tight...</h1>
    <h1>We're validating up your app...</h1>
  </header>
</body>

<script>
  // Get URL parameters
  const { code, orgName } = getParams(window.location.href);

  var xhr = new XMLHttpRequest();
  xhr.open('POST', `https://api.github.com/app-manifests/${code}/conversions`, true);
  xhr.send();

  xhr.onreadystatechange = () => {
    // We're not checking for a 2xx response code because GitHub's endpoint started returning 500s
    //  a few days into development. Unable to repro 2xxs. Despite the bad status codes, the app
    //  in question is still getting created, and that's all we care about here.
    if (xhr.readyState === 4) {
      window.location.replace(`https://cyamonide.github.io/use-herald-action/post-setup`);
    }
  };
</script>
